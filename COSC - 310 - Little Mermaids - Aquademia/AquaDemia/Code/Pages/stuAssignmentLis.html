<?php
require_once 'config.php';
include_once '...\includes\dbh.inc.php';

// just for the test
$CourseID = "COSC310";

// $CourseID was stored when user click into the course,
// access created assigenments in this course:
$sql_1 = "SELECT AssignmentName, ReleaseDate, DueDate,
          FROM CourseAssignments
          WHERE CourseID = '$CourseID'";

// $UserID was stored when user has logged in
// access students' info on assignments
$sql_2 = "SELECT AssignmentName, Grade, SubmissionTime
          FROM Assignments
          WHERE StudentID = '$UserID'";

// Initialize an empty array to store the organized data
$assignmentsData = array();

// Fetch data for SQL query 1
$result_1 = mysqli_query($connection, $sql_1);
if ($result_1) {
    while ($row = mysqli_fetch_assoc($result_1)) {
        $assignmentName = $row['AssignmentName'];
        $dueDate = $row['DueDate'];
        
        // Check if the assignment is current or past based on the due date
        // if DueDate < current, it is a past assignment, 
        // if DueDate > current, it ia a current assignment
        $isCurrent = strtotime($dueDate) > time();
        
        $assignmentsData[$assignmentName] = array(
            'ReleaseDate' => $row['ReleaseDate'],
            'DueDate' => $dueDate,
            'Grade' => -1, // Initialize Grade as -1
            'SubmissionTime' => null, // Initialize SubmissionTime as null
            'IsCurrent' => $isCurrent // Store whether the assignment is current or past
        );
    }
}
// Fetch data for SQL query 2
$result_2 = mysqli_query($connection, $sql_2);
if ($result_2) {
    while ($row = mysqli_fetch_assoc($result_2)) {
        $assignmentName = $row['AssignmentName'];
        // Check if the assignment name exists in the $assignmentsData array
        if (array_key_exists($assignmentName, $assignmentsData)) {
            // Update Grade and SubmissionTime for the assignment
            $assignmentsData[$assignmentName]['Grade'] = $row['Grade'];
            $assignmentsData[$assignmentName]['SubmissionTime'] = $row['SubmissionTime'];
        }
    }
}

// Now $assignmentsData contains ReleaseDate, DueDate, Grade, and SubmissionTime for each assignment
// print_r($assignmentsData);

// Close the database connection
mysqli_close($connection);

?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Courses</title>
    <style> 
 
    </style>
    
</head>
<body>


<h1>Assignments</h1>
<h2>Current</h2>
<ul>
    <?php foreach ($assignmentsData as $assignmentName => $assignmentDetails) {
        if ($assignmentDetails['IsCurrent']) {
            echo "<li>$assignmentName (Due Date: {$assignmentDetails['DueDate']}) - Grade: {$assignmentDetails['Grade']}, Release Date: {$assignmentDetails['ReleaseDate']}, Submission Time: {$assignmentDetails['SubmissionTime']}</li>";
        }
    } ?>
</ul>

<h2>Past</h2>
<ul>
    <?php foreach ($assignmentsData as $assignmentName => $assignmentDetails) {
        if (!$assignmentDetails['IsCurrent']) {
            echo "<li>$assignmentName (Due Date: {$assignmentDetails['DueDate']}) - Grade: {$assignmentDetails['Grade']}, Release Date: {$assignmentDetails['ReleaseDate']}, Submission Time: {$assignmentDetails['SubmissionTime']}</li>";
        }
    } ?>
</ul>
</body>
